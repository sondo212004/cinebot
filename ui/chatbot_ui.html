<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CineBot - T∆∞ V·∫•n Phim Th√¥ng Minh</title>
    <link rel="stylesheet" href="chatbot_ui.css">
</head>

<body>
    <div class="chat-container">
        <div class="chat-header">
            <div class="status-indicator"></div>
            <h1>üé¨ CineBot</h1>
            <p>Chuy√™n gia t∆∞ v·∫•n phim ·∫£nh th√¥ng minh</p>
            <div class="session-info">
                <span>Session: <span id="session-id">...</span></span>
                <div class="control-buttons">
                    <div class="control-btn" onclick="clearHistory()">üóëÔ∏è X√≥a l·ªãch s·ª≠</div>
                    <div class="control-btn" onclick="loadHistory()">üìú T·∫£i l·ªãch s·ª≠</div>
                    <div class="control-btn" onclick="toggleStream()">
                        <span id="stream-toggle">üîÑ Stream: ON</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="chat-messages" id="chat-messages">
            <div class="welcome-message">
                <h3>Ch√†o m·ª´ng ƒë·∫øn v·ªõi CineBot! üé¨</h3>
                <p>T√¥i c√≥ th·ªÉ gi√∫p b·∫°n:</p>
                <div class="quick-questions">
                    <div class="quick-question" onclick="sendQuickQuestion('G·ª£i √Ω phim hay ƒë·ªÉ xem cu·ªëi tu·∫ßn')">üçø Phim
                        cu·ªëi tu·∫ßn</div>
                    <div class="quick-question" onclick="sendQuickQuestion('Phim chi·∫øu r·∫°p t·∫°i H√† N·ªôi h√¥m nay')">üé≠ Phim
                        chi·∫øu r·∫°p</div>
                    <div class="quick-question" onclick="sendQuickQuestion('Phim h√†nh ƒë·ªông hay nh·∫•t 2025')">‚ö° Phim h√†nh
                        ƒë·ªông 2024</div>
                    <div class="quick-question" onclick="sendQuickQuestion('Th√¥ng tin v·ªÅ phim Avengers')">ü¶∏ Th√¥ng tin
                        phim</div>
                </div>
            </div>
        </div>

        <div class="chat-input-container">
            <textarea class="chat-input" id="message-input" placeholder="H·ªèi t√¥i v·ªÅ phim ·∫£nh, l·ªãch chi·∫øu, di·ªÖn vi√™n..."
                rows="1" onkeydown="handleKeyDown(event)"></textarea>
            <button class="send-button" id="send-button" onclick="sendMessage()">
                ‚û§
            </button>
        </div>
    </div>

    <script>
        // Configuration
        // const API_BASE_URL = 'https://sondo212004--cinebot-fastapi-fastapi-app.modal.run/';
        const API_BASE_URL = 'http://localhost:8000';   
        let sessionId = generateSessionId();
        let isStreaming = true;
        let isLoading = false;

        // Initialize
        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('session-id').textContent = sessionId.substring(0, 8);
            autoResizeTextarea();
        });

        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function autoResizeTextarea() {
            const textarea = document.getElementById('message-input');
            textarea.addEventListener('input', function () {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });
        }

        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function sendQuickQuestion(question) {
            document.getElementById('message-input').value = question;
            sendMessage();
        }

        async function sendMessage() {
            const messageInput = document.getElementById('message-input');
            const message = messageInput.value.trim();

            if (!message || isLoading) return;

            addMessage(message, 'user');
            messageInput.value = '';
            messageInput.style.height = 'auto';
            setLoading(true);

            try {
                if (isStreaming) {
                    await sendStreamingMessage(message);
                } else {
                    await sendRegularMessage(message);
                }
            } catch (error) {
                console.error('Error:', error);
                showError('C√≥ l·ªói x·∫£y ra khi g·ª≠i tin nh·∫Øn. Vui l√≤ng th·ª≠ l·∫°i.');
            } finally {
                setLoading(false);
            }
        }

        async function sendRegularMessage(message) {
            const response = await fetch(`${API_BASE_URL}/chat`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: message,
                    session_id: sessionId
                })
            });

            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

            const data = await response.json();
            addMessage(data.response, 'bot');
        }

        async function sendStreamingMessage(message) {
                addTypingIndicator();

                const response = await fetch(`${API_BASE_URL}/chat/stream`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        session_id: sessionId
                    })
                });

                if (!response.ok) {
                    removeTypingIndicator();
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let botMessage = '';
                let botMessageElement = null;
                let buffer = ''; // Th√™m buffer ƒë·ªÉ x·ª≠ l√Ω c√°c d√≤ng SSE kh√¥ng ho√†n ch·ªânh

                try {
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        buffer += decoder.decode(value, { stream: true }); // Gi·∫£i m√£ v√† th√™m v√†o buffer

                        // X·ª≠ l√Ω t·ª´ng d√≤ng ho√†n ch·ªânh trong buffer
                        const lines = buffer.split('\n');
                        buffer = lines.pop(); // Gi·ªØ l·∫°i d√≤ng cu·ªëi c√πng (c√≥ th·ªÉ kh√¥ng ho√†n ch·ªânh) trong buffer

                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const rawData = line.substring(6).trim(); // L·∫•y ph·∫ßn sau 'data: ' v√† lo·∫°i b·ªè kho·∫£ng tr·∫Øng

                                if (rawData.length > 0) { // ƒê·∫£m b·∫£o c√≥ d·ªØ li·ªáu
                                    if (rawData === '[DONE]') { // X·ª≠ l√Ω t√≠n hi·ªáu k·∫øt th√∫c stream
                                        break;
                                    }
                                    try {
                                        const parsedData = JSON.parse(rawData); // Th·ª≠ parse JSON

                                        if (parsedData.content) { // N·∫øu c√≥ tr∆∞·ªùng 'content'
                                            if (!botMessageElement) {
                                                removeTypingIndicator();
                                                botMessageElement = addMessage('', 'bot', true);
                                            }
                                            botMessage += parsedData.content; // N·ªëi n·ªôi dung
                                            updateMessage(botMessageElement, botMessage);
                                        } else if (parsedData.error) { // N·∫øu c√≥ tr∆∞·ªùng 'error'
                                            showError(`L·ªói t·ª´ bot: ${parsedData.error}`);
                                        }
                                    } catch (e) {
                                        // N·∫øu kh√¥ng ph·∫£i JSON h·ª£p l·ªá (c√≥ th·ªÉ l√† l·ªói ho·∫∑c ƒë·ªãnh d·∫°ng kh√°c)
                                        console.warn("Received non-JSON data or malformed JSON:", rawData, e);
                                        if (!botMessageElement) {
                                            removeTypingIndicator();
                                            botMessageElement = addMessage('', 'bot', true);
                                        }
                                        botMessage += rawData; // N·ªëi tr·ª±c ti·∫øp d·ªØ li·ªáu th√¥ (c√≥ th·ªÉ l√† l·ªói)
                                        updateMessage(botMessageElement, botMessage);
                                    }
                                }
                            }
                        }
                    }
                } catch (error) {
                    removeTypingIndicator();
                    console.error('Error during streaming:', error);
                    showError('C√≥ l·ªói x·∫£y ra khi nh·∫≠n ph·∫£n h·ªìi stream.');
                } finally {
                    removeTypingIndicator(); // ƒê·∫£m b·∫£o ·∫©n typing indicator khi k·∫øt th√∫c
                    setLoading(false); // ƒê·∫£m b·∫£o t·∫Øt loading
                    scrollToBottom(); // Cu·ªôn xu·ªëng cu·ªëi ƒë·ªÉ th·∫•y to√†n b·ªô tin nh·∫Øn
                }
            }

        function addMessage(content, sender, isStreaming = false) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;

            const contentDiv = document.createElement('div');
            contentDiv.innerHTML = formatMessage(content);
            messageDiv.appendChild(contentDiv);

            const timeDiv = document.createElement('div');
            timeDiv.className = 'message-time';
            timeDiv.textContent = new Date().toLocaleTimeString('vi-VN');
            messageDiv.appendChild(timeDiv);

            messagesContainer.appendChild(messageDiv);
            scrollToBottom();
            return isStreaming ? messageDiv : null;
        }

        function updateMessage(messageElement, content) {
            const contentDiv = messageElement.querySelector('div');
            contentDiv.innerHTML = formatMessage(content);
            scrollToBottom();
        }

        function formatMessage(content) {
            return content
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n/g, '<br>');
        }

        function addTypingIndicator() {
            const messagesContainer = document.getElementById('chat-messages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.id = 'typing-indicator';
            typingDiv.innerHTML = `
                <div class="typing-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            `;
            messagesContainer.appendChild(typingDiv);
            scrollToBottom();
        }

        function removeTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) typingIndicator.remove();
        }

        function setLoading(loading) {
            isLoading = loading;
            const sendButton = document.getElementById('send-button');
            const messageInput = document.getElementById('message-input');

            sendButton.disabled = loading;
            messageInput.disabled = loading;
            sendButton.innerHTML = loading ? '‚è≥' : '‚û§';
        }

        function scrollToBottom() {
            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showError(message) {
            const messagesContainer = document.getElementById('chat-messages');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            messagesContainer.appendChild(errorDiv);
            scrollToBottom();

            setTimeout(() => errorDiv.remove(), 5000);
        }

        async function clearHistory() {
            try {
                const response = await fetch(`${API_BASE_URL}/history/${sessionId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    document.getElementById('chat-messages').innerHTML = `
                        <div class="welcome-message">
                            <h3>L·ªãch s·ª≠ ƒë√£ ƒë∆∞·ª£c x√≥a! üé¨</h3>
                            <p>B·∫°n c√≥ th·ªÉ b·∫Øt ƒë·∫ßu cu·ªôc tr√≤ chuy·ªán m·ªõi.</p>
                        </div>
                    `;
                } else {
                    showError('Kh√¥ng th·ªÉ x√≥a l·ªãch s·ª≠. Vui l√≤ng th·ª≠ l·∫°i.');
                }
            } catch (error) {
                console.error('Error clearing history:', error);
                showError('C√≥ l·ªói x·∫£y ra khi x√≥a l·ªãch s·ª≠.');
            }
        }

        async function loadHistory() {
            try {
                const response = await fetch(`${API_BASE_URL}/history/${sessionId}`);

                if (response.ok) {
                    const messages = await response.json();
                    const messagesContainer = document.getElementById('chat-messages');
                    messagesContainer.innerHTML = '';

                    if (messages.length === 0) {
                        messagesContainer.innerHTML = `
                            <div class="welcome-message">
                                <h3>Kh√¥ng c√≥ l·ªãch s·ª≠ tr√≤ chuy·ªán! üé¨</h3>
                                <p>H√£y b·∫Øt ƒë·∫ßu cu·ªôc tr√≤ chuy·ªán ƒë·∫ßu ti√™n.</p>
                            </div>
                        `;
                        return;
                    }

                    messages.forEach(msg => {
                        if (msg.role !== 'system') {
                            const sender = msg.role === 'human' ? 'user' : 'bot';
                            addMessage(msg.content, sender);
                        }
                    });
                } else {
                    showError('Kh√¥ng th·ªÉ t·∫£i l·ªãch s·ª≠. Vui l√≤ng th·ª≠ l·∫°i.');
                }
            } catch (error) {
                console.error('Error loading history:', error);
                showError('C√≥ l·ªói x·∫£y ra khi t·∫£i l·ªãch s·ª≠.');
            }
        }

        function toggleStream() {
            isStreaming = !isStreaming;
            const toggleElement = document.getElementById('stream-toggle');
            toggleElement.textContent = `üîÑ Stream: ${isStreaming ? 'ON' : 'OFF'}`;

            toggleElement.parentElement.style.background = isStreaming
                ? 'rgba(255, 255, 255, 0.2)'
                : 'rgba(239, 68, 68, 0.2)';
        }

        // Connection status handlers
        window.addEventListener('online', () => {
            document.querySelector('.status-indicator').style.background = '#4ade80';
        });

        window.addEventListener('offline', () => {
            document.querySelector('.status-indicator').style.background = '#ef4444';
            showError('M·∫•t k·∫øt n·ªëi internet. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi.');
        });
    </script>
</body>

</html>